<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Transcription</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Audio Transcription</h1>
            <p>Listen and transcribe with metadata</p>
        </header>

        <!-- Top-of-page Transcription Guidelines -->
        <section class="guidelines" aria-labelledby="guidelines-title" id="guidelines">
            <div class="guidelines-header">
                <h2 id="guidelines-title">Transcription Guidelines</h2>
                <button type="button" class="guidelines-toggle" id="guidelinesToggle" aria-controls="guidelinesBody" aria-expanded="true" title="Collapse guidelines">Hide</button>
            </div>
            <div class="guidelines-body" id="guidelinesBody">
                <ul>
                    <li>Write the full transcription in <span class="highlight">Sinhala</span> with correct spelling and punctuation.</li>
                    <li>If you lack a Sinhala keyboard, enable the <span class="highlight">built‑in Sinhala phonetic keyboard</span> (toggle above the textbox) and type phonetically.</li>
                    <li>Use the Google reference transcription <span class="highlight">for reference only</span>. It is often inaccurate — please listen and correct.</li>
                    <li>Keep <span class="highlight">English words in English</span> when spoken. Quickly switch Sinhala/English via the chip in the textbox or press <kbd>Ctrl</kbd> + <kbd>Space</kbd>.</li>
                    <li><span class="highlight">Ignore hesitations/fillers</span> like “ම්ම්…” when they don’t add meaning.<br>
                        Example: “අද මම ම්ම්ම්ම්.... මොනවද කන්නේ.” → “අද මම මොනවද කන්නේ.”
                    </li>
                    <li>Provide <span class="highlight">metadata</span> after transcribing: speaker gender, background noise, code‑mixed content, overlapping speakers.</li>
                </ul>
            </div>
        </section>

        <!-- Messages -->
        {% if success_message %}
        <div class="message success">
            <span class="icon">✓</span>
            {{ success_message }}
        </div>
        {% endif %}

        {% if error_message %}
        <div class="message error">
            <span class="icon">×</span>
            {{ error_message }}
        </div>
        {% endif %}

        <!-- Main Content -->
        {% if audio %}
        <div class="audio-section">
            
            <!-- Google Transcription Reference -->
            {% if audio.google_transcription %}
            <div class="reference-section">
                <div class="reference-header">
                    <h3>Reference Transcription</h3>
                    <button type="button" class="reference-copy-btn" onclick="copyReferenceText()" title="Copy reference text to transcription field">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" />
                        </svg>
                        Quick Copy
                    </button>
                </div>
                <div class="reference-text">{{ audio.google_transcription }}</div>
                <small class="reference-note">For reference only. Please provide your own transcription below.</small>
            </div>
            {% endif %}

            <!-- Audio Player -->
            <div class="audio-player">
                <audio preload="auto" id="audioPlayer" crossorigin="anonymous" style="display: none;">
                    <source src="{{ audio.gcs_signed_url }}" type="audio/mpeg">
                    <source src="{{ audio.gcs_signed_url }}" type="audio/mp4">
                    <source src="{{ audio.gcs_signed_url }}" type="audio/wav">
                    <source src="{{ audio.gcs_signed_url }}" type="audio/ogg">
                    <source src="{{ audio.gcs_signed_url }}" type="audio/webm">
                    <source src="{{ audio.gcs_signed_url }}">
                    Your browser does not support the audio element. 
                    <a href="{{ audio.gcs_signed_url }}" target="_blank">Download audio file</a>
                </audio>
                
                <!-- Custom Audio Player UI -->
                <div class="custom-audio-player">
                    <div class="audio-info">
                        <div class="audio-meta">
                            <span class="duration" id="audioDuration">--:--</span>
                            <span class="separator">•</span>
                            <span class="speed" id="audioSpeed">1x</span>
                        </div>
                    </div>
                    
                    <div class="audio-progress-container">
                        <div class="audio-progress">
                            <div class="progress-bar" id="progressBar"></div>
                            <div class="progress-handle" id="progressHandle"></div>
                        </div>
                        <div class="time-display">
                            <span class="current-time" id="currentTime">0:00</span>
                            <span class="total-time" id="totalTime">0:00</span>
                        </div>
                    </div>
                    
                    <div class="audio-controls">
                        <button type="button" class="control-btn replay-btn" onclick="replayAudio()" title="Replay from beginning">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,5V1L7,6L12,11V7A6,6 0 0,1 18,13A6,6 0 0,1 12,19A6,6 0 0,1 6,13H4A8,8 0 0,0 12,21A8,8 0 0,0 20,13A8,8 0 0,0 12,5Z" />
                            </svg>
                        </button>
                        
                        <button type="button" class="control-btn play-pause-btn" id="playPauseBtn" onclick="toggleAudio()" title="Play/Pause">
                            <svg class="play-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8,5.14V19.14L19,12.14L8,5.14Z" />
                            </svg>
                            <svg class="pause-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                                <path d="M14,19H18V5H14M6,19H10V5H6V19Z" />
                            </svg>
                        </button>
                        
                        <div class="speed-controls">
                            <button type="button" class="speed-btn" onclick="adjustSpeed(0.5)" data-speed="0.5">0.5x</button>
                            <button type="button" class="speed-btn" onclick="adjustSpeed(0.75)" data-speed="0.75">0.75x</button>
                            <button type="button" class="speed-btn active" onclick="adjustSpeed(1.0)" data-speed="1.0">1x</button>
                            <button type="button" class="speed-btn" onclick="adjustSpeed(1.25)" data-speed="1.25">1.25x</button>
                            <button type="button" class="speed-btn" onclick="adjustSpeed(1.5)" data-speed="1.5">1.5x</button>
                        </div>
                        
                        <button type="button" class="control-btn volume-btn" onclick="toggleMute()" title="Mute/Unmute">
                            <svg class="volume-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18.01,19.86 21,16.28 21,12C21,7.72 18.01,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z" />
                            </svg>
                            <svg class="mute-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                                <path d="M12,4L9.91,6.09L12,8.18M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12Z" />
                            </svg>
                        </button>
                    </div>
                </div>               
            </div>
                

            <!-- Transcription Form -->
            <form method="post" action="/submit-transcription" class="transcription-form" id="transcriptionForm">
                <input type="hidden" name="audio_id" value="{{ audio.audio_id }}">
                <input type="hidden" name="is_audio_suitable" id="audioSuitableField" value="true">

                <!-- Transcription Input Section -->
                <div class="transcription-input-section">
                    <div class="form-group">
                        <label for="transcription">Your Transcription *</label>

                        <!-- Built-in Sinhala IME toggle (default OFF) -->
                        <div class="ime-toggle-container" style="margin-bottom: 8px;">
                            <span class="ime-toggle-label">Don't have a Sinhala keyboard? Try the built-in Sinhala phonetic keyboard.</span>
                            <label class="toggle-switch" aria-label="Enable Sinhala phonetic keyboard">
                                <input type="checkbox" id="imeToggle" class="toggle-input" />
                                <span class="toggle-slider">
                                    <span class="toggle-text off">Off</span>
                                    <span class="toggle-text on">On</span>
                                </span>
                            </label>
                        </div>

                        <!-- Textarea wrapped to host the inline chip "සි | en" -->
                        <div class="ime-container">
                            <textarea 
                                name="transcription" 
                                id="transcription" 
                                required 
                                placeholder="Please type exactly what you hear in the audio..."
                                rows="4"
                            ></textarea>
                            <button type="button" id="imeChip" class="ime-chip" title="Toggle Sinhala/English (Ctrl+Space)" aria-label="Toggle Sinhala/English">සි | en</button>
                        </div>

                        <small class="field-note">Be as accurate as possible. Include punctuation and proper spelling.</small>
                    </div>
                </div>

                <!-- Audio Suitability Check -->
                <div class="suitability-section">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="audioNotSuitable" onchange="handleAudioSuitabilityChange(this)">
                            <span class="checkmark"></span>
                            This audio is not suitable for transcription
                        </label>
                        <small class="field-note">Check this if the audio has issues that make it impossible to transcribe accurately (e.g., completely inaudible, corrupted, wrong language, etc.)</small>
                    </div>
                </div>

                <div class="metadata-section">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="speaker_gender">Speaker Gender *</label>
                        <select name="speaker_gender" id="speaker_gender" required>
                            <option value="">Select gender...</option>
                            {% for gender in speaker_genders %}
                            <option value="{{ gender }}">{{ gender.title() }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="has_noise" value="true">
                        <span class="checkmark"></span>
                        Audio contains background noise
                    </label>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_code_mixed" value="true">
                        <span class="checkmark"></span>
                        Audio contains code-mixed content (multiple languages)
                    </label>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_speaker_overlapping" value="true">
                        <span class="checkmark"></span>
                        Multiple speakers are talking at the same time
                    </label>
                </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Submit Transcription</button>
                    <a href="/new-audio" class="btn btn-secondary">Skip Audio</a>
                </div>
            </form>
        </div>

        {% else %}
        <!-- No Audio Available -->
        <div class="no-audio">
            <div class="no-audio-icon">♪</div>
            <h2>No Audio Available</h2>
            <p>No audio files need transcription at the moment.</p>
            <a href="/" class="btn btn-primary">Refresh</a>
        </div>
        {% endif %}

        <!-- Footer -->
        <footer>
            <p>Audio Transcription Service</p>
        </footer>
    </div>

    <!-- Audio Suitability Confirmation Modal -->
    <div id="audioSuitabilityModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Audio Suitability</h3>
                <span class="modal-close" onclick="closeAudioSuitabilityModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>You have indicated that this audio is <strong>not suitable</strong> for transcription.</p>
                <p>This means the audio has issues such as:</p>
                <ul>
                    <li>Completely inaudible or corrupted audio</li>
                    <li>Wrong language content</li>
                    <li>No speech content</li>
                    <li>Other technical issues preventing transcription</li>
                </ul>
                <p><strong>Are you sure you want to mark this audio as unsuitable?</strong></p>
                <p>This will immediately submit the record without requiring transcription.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAudioSuitabilityModal()">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmAudioNotSuitable()">Yes, Mark as Unsuitable</button>
            </div>
        </div>
    </div>

    <script src="/static/script.js"></script>
    <script src="/static/sin-phonetic-ime.js"></script>
    <script>
        function handleAudioSuitabilityChange(checkbox) {
            if (checkbox.checked) {
                // Show modal for confirmation
                document.getElementById('audioSuitabilityModal').style.display = 'block';
            } else {
                // Reset to suitable
                document.getElementById('audioSuitableField').value = 'true';
            }
        }

        function closeAudioSuitabilityModal() {
            document.getElementById('audioSuitabilityModal').style.display = 'none';
            // Uncheck the checkbox
            document.getElementById('audioNotSuitable').checked = false;
        }

        async function confirmAudioNotSuitable() {
            // Set the hidden field to false
            document.getElementById('audioSuitableField').value = 'false';
            
            // Clear required validation from form fields since we're submitting as unsuitable
            const form = document.getElementById('transcriptionForm');
            const transcriptionField = document.getElementById('transcription');
            const genderField = document.getElementById('speaker_gender');
            
            // Set default values for submission
            transcriptionField.value = 'Audio not suitable for transcription';
            genderField.value = 'cannot_recognized';
            
            // Close modal
            document.getElementById('audioSuitabilityModal').style.display = 'none';
            
            try {
                // Show loading state
                showNotification('Submitting audio suitability...', 'info', 2000);
                
                // Prepare form data
                const formData = new FormData(form);
                
                // Submit via AJAX
                const response = await fetch('/submit-transcription', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success popup
                    showSuccessPopup('Audio marked as unsuitable. Loading new audio...');
                    
                    // Reset form
                    resetForm();
                    
                    // Load new audio after popup
                    setTimeout(async () => {
                        await loadNewAudio();
                    }, 2000);
                    
                } else {
                    showNotification(result.message, 'error');
                    // Reset form state on error
                    resetForm();
                }
                
            } catch (error) {
                console.error('Error submitting audio suitability:', error);
                showNotification('Network error. Please check your connection and try again.', 'error');
                // Reset form state on error
                resetForm();
            }
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('audioSuitabilityModal');
            if (event.target === modal) {
                closeAudioSuitabilityModal();
            }
        }
    </script>
</body>
</html>
