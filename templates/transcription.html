<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Transcription</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="/static/assets/logo.png" type="image/png">
</head>
<body>
{% from "components/audio_player.html" import render_audio_player %}
{% from "components/transcription_form_parts.html" import render_transcription_input, render_audio_suitability, render_metadata_fields %}
{% from "components/admin_ui.html" import render_admin_indicator, render_admin_selection_modal, render_admin_leaderboard_ui %}
    <div class="container">
        <header>
            <h1>Audio Transcription</h1>
            <p>Listen and transcribe with metadata</p>
            {{ render_admin_indicator() }}
        </header>

        <!-- Top-of-page Transcription Guidelines -->
        <section class="guidelines" aria-labelledby="guidelines-title" id="guidelines">
            <div class="guidelines-header">
                <h2 id="guidelines-title">Transcription Guidelines</h2>
                <button type="button" class="guidelines-toggle" id="guidelinesToggle" aria-controls="guidelinesBody" aria-expanded="true" title="Collapse guidelines">Hide</button>
            </div>
            <div class="guidelines-body" id="guidelinesBody">
                <ul>
                    <li>Listen carefully to the audio and transcribe exactly what you hear. <span class="highlight">Focus on accuracy</span> and correct spelling.</li>
                    <li>Write the full transcription in <span class="highlight">Sinhala (Not Singlish)</span></li>
                    <li>If you lack a Sinhala keyboard, enable the <span class="highlight">built‑in Sinhala phonetic keyboard</span> (toggle above the textbox) and type phonetically.</li>
                    <li>Keep <span class="highlight">English words in English</span> when spoken. Quickly switch Sinhala/English via the chip in the textbox or press <kbd>Ctrl</kbd> + <kbd>Space</kbd>.</li>
                    <li><span class="highlight">Ignore hesitations/fillers</span> like “ම්ම්…” when they don’t add meaning.<br>
                        Example: “අද මම ම්ම්ම්ම්.... මොනවද කන්නේ.” → “අද මම මොනවද කන්නේ.”
                    </li>
                    <li>Provide <span class="highlight">metadata</span> after transcribing: speaker gender, background noise, code‑mixed content, overlapping speakers.</li>
                </ul>
            </div>
        </section>

        <!-- Messages -->
        {% if success_message %}
        <div class="message success">
            <span class="icon">✓</span>
            {{ success_message }}
        </div>
        {% endif %}

        {% if error_message %}
        <div class="message error">
            <span class="icon">×</span>
            {{ error_message }}
        </div>
        {% endif %}

        <!-- Main Content -->
        {% if audio %}
        <div class="audio-section">
            
            <!-- Google Transcription Reference (Hidden by default; visible when an Admin is selected via Ctrl+`) -->
            {% if audio.google_transcription %}
            <div class="reference-section" id="referenceSection" style="display: none;">
                <div class="reference-header">
                    <h3>Reference Transcription</h3>
                    <button type="button" class="reference-copy-btn" onclick="copyReferenceText()" title="Copy reference text to transcription field">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" />
                        </svg>
                        Quick Copy
                    </button>
                </div>
                <div class="reference-text">{{ audio.google_transcription }}</div>
                <small class="reference-note">Development reference - not visible to regular users.</small>
            </div>
            {% endif %}

            <!-- Audio Player -->
            {{ render_audio_player(audio) }}

            <!-- Transcription Form -->
            <form method="post" action="/submit-transcription" class="transcription-form" id="transcriptionForm" data-form-mode="transcription">
                <input type="hidden" name="audio_id" value="{{ audio.audio_id }}">
                <input type="hidden" name="is_audio_suitable" id="audioSuitableField" value="true">
                <input type="hidden" name="admin" id="adminField" value="">

                {{ render_transcription_input() }}

                {{ render_audio_suitability() }}

                {{ render_metadata_fields(speaker_genders) }}

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Submit Transcription</button>
                    <a href="/new-audio" class="btn btn-secondary">Skip Audio</a>
                </div>
            </form>
        </div>

        {% else %}
        <!-- No Audio Available -->
        <div class="no-audio">
            <div class="no-audio-icon">♪</div>
            <h2>No Audio Available</h2>
            <p>No audio files need transcription at the moment.</p>
            <a href="/" class="btn btn-primary">Refresh</a>
        </div>
        {% endif %}

        <!-- Footer -->
        <footer>
            <p>Audio Transcription Service</p>
        </footer>
    </div>

    <!-- Audio Suitability Confirmation Modal -->
    <div id="audioSuitabilityModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Audio Suitability</h3>
                <span class="modal-close" onclick="closeAudioSuitabilityModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>You have indicated that this audio is <strong>not suitable</strong> for transcription.</p>
                <p>This means the audio has issues such as:</p>
                <ul>
                    <li>Completely inaudible or corrupted audio</li>
                    <li>Wrong language content</li>
                    <li>No speech content</li>
                    <li>Other technical issues preventing transcription</li>
                </ul>
                <p><strong>Are you sure you want to mark this audio as unsuitable?</strong></p>
                <p>This will immediately submit the record without requiring transcription.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAudioSuitabilityModal()">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmAudioNotSuitable()">Yes, Mark as Unsuitable</button>
            </div>
        </div>
    </div>

    {{ render_admin_selection_modal() }}

    {{ render_admin_leaderboard_ui() }}
    <script src="/static/script.js"></script>
    <script src="/static/sin-phonetic-ime.js"></script>
    <script>
        function handleAudioSuitabilityChange(checkbox) {
            if (checkbox.checked) {
                // Show modal for confirmation
                document.getElementById('audioSuitabilityModal').style.display = 'block';
            } else {
                // Reset to suitable
                document.getElementById('audioSuitableField').value = 'true';
            }
        }

        function closeAudioSuitabilityModal() {
            document.getElementById('audioSuitabilityModal').style.display = 'none';
            // Uncheck the checkbox
            document.getElementById('audioNotSuitable').checked = false;
        }

        async function confirmAudioNotSuitable() {
            // Set the hidden field to false
            document.getElementById('audioSuitableField').value = 'false';
            
            // Clear required validation from form fields since we're submitting as unsuitable
            const form = document.getElementById('transcriptionForm');
            const transcriptionField = document.getElementById('transcription');
            const genderField = document.getElementById('speaker_gender');
            
            // Set default values for submission
            transcriptionField.value = 'Audio not suitable for transcription';
            genderField.value = 'cannot_recognized';
            
            // Close modal
            document.getElementById('audioSuitabilityModal').style.display = 'none';
            
            try {
                // Show loading state
                showNotification('Submitting audio suitability...', 'info', 2000);
                
                // Prepare form data
                const formData = new FormData(form);
                
                // Submit via AJAX
                const response = await fetch('/submit-transcription', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success popup
                    showSuccessPopup('Audio marked as unsuitable. Loading new audio...');
                    
                    // Reset form
                    resetForm();
                    
                    // Load new audio after popup
                    setTimeout(async () => {
                        await loadNewAudio();
                    }, 2000);
                    
                } else {
                    showNotification(result.message, 'error');
                    // Reset form state on error
                    resetForm();
                }
                
            } catch (error) {
                console.error('Error submitting audio suitability:', error);
                showNotification('Network error. Please check your connection and try again.', 'error');
                // Reset form state on error
                resetForm();
            }
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('audioSuitabilityModal');
            if (event.target === modal) {
                closeAudioSuitabilityModal();
            }
        }
    </script>
</body>
</html>
