<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcription Validation</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="/static/assets/logo.png" type="image/png">
</head>
<body>
{% from "components/audio_player.html" import render_audio_player %}
{% from "components/transcription_form_parts.html" import render_transcription_input, render_audio_suitability, render_metadata_fields %}
{% from "components/admin_ui.html" import render_admin_indicator, render_admin_selection_modal, render_admin_leaderboard_ui %}
    <div class="container">
        <header>
            <h1>Transcription Validation</h1>
            <p>Review, correct, and approve submitted transcripts</p>
            {{ render_admin_indicator() }}
        </header>
        <section class="validation-progress" id="validationProgress">
            <div class="progress-header">
                <span class="progress-title">Validation Progress</span>
                <span class="progress-percent" id="validationProgressPercent">0%</span>
            </div>
            <div
                class="progress-track"
                id="validationProgressBar"
                role="progressbar"
                aria-valuemin="0"
                aria-valuemax="100"
                aria-valuenow="0"
            >
                <div class="progress-fill" id="validationProgressFill"></div>
            </div>
            <div class="progress-stats">
                <span><strong id="validationCompletedCount">0</strong> validated</span>
                <span><strong id="validationPendingCount">0</strong> remaining</span>
                <span><strong id="validationTotalCount">0</strong> total</span>
            </div>
        </section>
        {% if error_message %}
        <div class="message error">
            <span class="icon">!</span>
            {{ error_message }}
        </div>
        {% endif %}

        {% set has_item = initial_item is not none %}
        {% if has_item %}
            {% set audio_context = initial_item.audio %}
            {% set transcription_context = initial_item.transcription %}
        {% else %}
            {% set audio_context = {
                "audio_id": "",
                "audio_filename": "",
                "google_transcription": None,
                "transcription_count": 0,
                "gcs_signed_url": ""
            } %}
            {% set transcription_context = {
                "trans_id": "",
                "audio_id": "",
                "transcription": "",
                "speaker_gender": "",
                "has_noise": False,
                "is_code_mixed": False,
                "is_speaker_overlappings_exist": False,
                "is_audio_suitable": True,
                "admin": "",
                "validated_at": null,
                "created_at": None
            } %}
        {% endif %}

        <section class="audio-section" id="validationWorkArea" {% if not has_item %}style="display:none;"{% endif %}>
            {{ render_audio_player(audio_context) }}

            <form class="transcription-form" id="transcriptionForm" data-form-mode="validation">
                <input type="hidden" name="trans_id" value="{{ transcription_context.trans_id }}">
                <input type="hidden" name="audio_id" value="{{ transcription_context.audio_id }}">
                <input type="hidden" name="is_audio_suitable" id="audioSuitableField" value="{{ 'true' if transcription_defaults.get('is_audio_suitable', True) else 'false' }}">
                <input type="hidden" name="admin" id="adminField" value="{{ transcription_defaults.get('admin', '') or '' }}">

                {{ render_transcription_input(
                    initial_text=transcription_defaults.get('transcription', ''),
                    label='Validated Transcription *',
                    show_cleanup_button=True
                ) }}

                {% if audio_context.google_transcription %}
                <div class="reference-toggle-section">
                    <button type="button" class="reference-toggle-btn" id="referenceToggleBtn" onclick="toggleReferenceTranscription()">
                        <span class="toggle-icon">â–¶</span>
                        Show Google Transcription Reference
                    </button>
                    <div class="reference-section-val" id="referenceSection">
                        <div class="reference-content">
                            <div class="reference-text">{{ audio_context.google_transcription }}</div>
                            <button type="button" class="reference-copy-btn" onclick="copyReferenceText()" title="Copy reference text to transcription field">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" />
                                </svg>
                                Quick Copy
                            </button>
                        </div>
                        <small class="reference-note">Reference transcript from Google Speech-to-Text - use as guidance only.</small>
                    </div>
                </div>
                {% endif %}

                {{ render_audio_suitability(
                    is_audio_suitable=transcription_defaults.get('is_audio_suitable', True),
                    mode='validation'
                ) }}

                {{ render_metadata_fields(speaker_genders, transcription_defaults) }}

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="validateSubmitBtn">Mark as Validated</button>
                    <button type="button" class="btn btn-secondary" id="fetchNextBtn">Next Pending</button>
                </div>
            </form>
        </section>

        <section class="no-audio" id="noValidationPlaceholder" {% if has_item %}style="display:none;"{% endif %}>
            <div class="no-audio-icon">
</div>
            <h2>No submissions waiting</h2>
            <p>All available transcriptions have been reviewed. Great job!</p>
            <a href="/" class="btn btn-primary">Back to Collection</a>
        </section>

        <footer>
            <p>Audio Transcription Service &mdash; Validation Console</p>
        </footer>
    </div>

    {{ render_admin_selection_modal() }}

    {{ render_admin_leaderboard_ui() }}

    <script type="application/json" id="validation-data">{{ initial_item_json | safe }}</script>
    <script>
        // Parse the JSON data from the script tag
        const dataScript = document.getElementById('validation-data');
        window.initialValidationItem = dataScript ? JSON.parse(dataScript.textContent) : null;
    </script>
    <script src="/static/script.js"></script>
    <script src="/static/sin-phonetic-ime.js"></script>
    <script src="/static/validate.js"></script>
</body>
</html>
